# Automatically generate AI-powered summaries of code changes
# Runs on commits to develop branches and posts summary as commit comment
name: Diff Summary

on:
  push:
    branches:
      - develop
      - 'develop/**'
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  summarize:
    name: Generate AI Summary
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For posting commit comments

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for git diff

    - name: Check if merge commit
      id: check_merge
      run: |
        # Check if this is a merge commit (has 2+ parents)
        PARENT_COUNT=$(git rev-list --parents -n 1 ${{ github.sha }} | awk '{print NF-1}')
        if [ "$PARENT_COUNT" -gt 1 ]; then
          echo "is_merge=true" >> $GITHUB_OUTPUT
          echo "âš ï¸  This is a merge commit - skipping AI summary"
        else
          echo "is_merge=false" >> $GITHUB_OUTPUT
          echo "âœ… This is a regular commit - will generate AI summary"
        fi

    - name: Set up Python 3.11
      if: steps.check_merge.outputs.is_merge == 'false'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      if: steps.check_merge.outputs.is_merge == 'false'
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
        cache-dependency-glob: "**/pyproject.toml"

    - name: Cache OpenAI dependencies
      if: steps.check_merge.outputs.is_merge == 'false'
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-openai-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-openai-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      if: steps.check_merge.outputs.is_merge == 'false'
      run: |
        uv pip install --system openai

    - name: Determine diff refs
      if: steps.check_merge.outputs.is_merge == 'false'
      id: refs
      run: |
        # For push events, compare with previous commit
        echo "base_ref=${{ github.event.before }}" >> $GITHUB_OUTPUT
        echo "head_ref=${{ github.sha }}" >> $GITHUB_OUTPUT

    - name: Generate summary
      if: steps.check_merge.outputs.is_merge == 'false'
      id: summary
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        # Run the summarize script and capture output
        python scripts/workflows/summarize_diff.py \
          --base-ref "${{ steps.refs.outputs.base_ref }}" \
          --head-ref "${{ steps.refs.outputs.head_ref }}" \
          --max-chars 500 > summary.txt

        # Read the summary and set as output
        echo "summary<<EOF" >> $GITHUB_OUTPUT
        cat summary.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Post commit comment
      if: steps.check_merge.outputs.is_merge == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('summary.txt', 'utf8');

          // Post summary as a commit comment
          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: '${{ github.sha }}',
            body: `## ðŸ¤– AI-Generated Commit Summary\n\n${summary}\n\n---\n*Generated by OpenAI GPT-5 nano based on code changes*`
          });

    - name: Print summary to logs
      if: steps.check_merge.outputs.is_merge == 'false'
      run: |
        echo "=========================================="
        echo "AI-GENERATED SUMMARY"
        echo "=========================================="
        cat summary.txt || echo "No summary generated"
        echo "=========================================="

    - name: Upload summary artifact
      if: steps.check_merge.outputs.is_merge == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: diff-summary-${{ github.sha }}
        path: summary.txt
        retention-days: 30
